<div class="eqLogic eqLogic-widget allowResize allowReorderCmd jeeHistoGraph #eqLogic_class# #class#"
     data-eqType="#eqType#"
     data-eqLogic_id="#id#"
     data-eqLogic_uid="#uid#"
     data-version="#version#"

     style="width:#width# !important; height:#height# !important; #style#;
            position: absolute; top:0; left:0; right:0; bottom:0;
            display: flex; flex-direction: column; overflow: hidden;">
    <center class="widget-name" style="flex: 0 0 auto; font-size: 0.9em;">
        <span class="reportModeVisible">#name_display# <span class="object_name">#object_name#</span></span>
        <a href="#eqLink#" class="reportModeHidden">#name_display# <span class="object_name">#object_name#</span></a>
        <span class="cmd refresh pull-right cursor" data-cmd_id="#refresh_id#" title="Rafraîchir">
            <i class="fas fa-sync"></i>
        </span>
    </center>

<style>
    .jeeHistoGraph .graphs-container { 
        flex: 1; min-height: 0; overflow: hidden; 
        display: grid; gap: 8px; padding: 4px; box-sizing: border-box; 
    }

    /* Layout automatique */
    .jeeHistoGraph .graphs-container.layout-auto { grid-template: 1fr / 1fr; }
    .jeeHistoGraph .graphs-container.layout-auto[data-nb-graphs="2"] { grid-template: 1fr 1fr / 1fr; }
    .jeeHistoGraph .graphs-container.layout-auto[data-nb-graphs="3"] { grid-template: 1fr 1fr / repeat(2, 1fr); }
    .jeeHistoGraph .graphs-container.layout-auto[data-nb-graphs="3"] > div:nth-child(1) { grid-area: 1 / 1; }
    .jeeHistoGraph .graphs-container.layout-auto[data-nb-graphs="3"] > div:nth-child(2) { grid-area: 1 / 2; }
    .jeeHistoGraph .graphs-container.layout-auto[data-nb-graphs="3"] > div:nth-child(3) { grid-area: 2 / 1 / 3 / 3; }
    .jeeHistoGraph .graphs-container.layout-auto[data-nb-graphs="4"] { grid-template: 1fr 1fr / 1fr 1fr; }

    /* Layouts personnalisés */
    .jeeHistoGraph .graphs-container.layout-1col[data-nb-graphs="1"]{ grid-template: 1fr / 1fr; }
    .jeeHistoGraph .graphs-container.layout-1col[data-nb-graphs="2"]{ grid-template: repeat(2, 1fr) / 1fr; }
    .jeeHistoGraph .graphs-container.layout-1col[data-nb-graphs="3"]{ grid-template: repeat(3, 1fr) / 1fr; }
    .jeeHistoGraph .graphs-container.layout-1col[data-nb-graphs="4"]{ grid-template: repeat(4, 1fr) / 1fr; }
    .jeeHistoGraph .graphs-container.layout-1row[data-nb-graphs="1"]{ grid-template: 1fr / 1fr; }
    .jeeHistoGraph .graphs-container.layout-1row[data-nb-graphs="2"]{ grid-template: 1fr / repeat(2, 1fr); }
    .jeeHistoGraph .graphs-container.layout-1row[data-nb-graphs="3"]{ grid-template: 1fr / repeat(3, 1fr); }
    .jeeHistoGraph .graphs-container.layout-1row[data-nb-graphs="4"]{ grid-template: 1fr / repeat(4, 1fr); }
    .jeeHistoGraph .graphs-container.layout-2x2 { grid-template: 1fr 1fr / 1fr 1fr; }

    /* 1 grand + 2 petits */
    .jeeHistoGraph .graphs-container.layout-1big-2small {grid-template: 1fr 1fr / 1fr 1fr; }
    .jeeHistoGraph .graphs-container.layout-1big-2small > div:nth-child(1) { grid-area: 1 / 1 / 2 / 3; }
    .jeeHistoGraph .graphs-container.layout-1big-2small > div:nth-child(2) { grid-area: 2 / 1; }
    .jeeHistoGraph .graphs-container.layout-1big-2small > div:nth-child(3) { grid-area: 2 / 2; }

    /* 2 petits + 1 grand */
    .jeeHistoGraph .graphs-container.layout-2small-1big {grid-template: 1fr 1fr / 1fr 1fr; }
    .jeeHistoGraph .graphs-container.layout-2small-1big > div:nth-child(1) { grid-area: 1 / 1; }
    .jeeHistoGraph .graphs-container.layout-2small-1big > div:nth-child(2) { grid-area: 1 / 2; }
    .jeeHistoGraph .graphs-container.layout-2small-1big > div:nth-child(3) { grid-area: 2 / 1 / 3 / 3; }

    /* 3 graphiques : 2 en haut, 1 centré en bas */
    .jeeHistoGraph .graphs-container.layout-3grid {grid-template: 1fr 1fr / repeat(4, 1fr); }
    .jeeHistoGraph .graphs-container.layout-3grid > div:nth-child(1) { grid-area: 1 / 1 / 1 / 2; }
    .jeeHistoGraph .graphs-container.layout-3grid > div:nth-child(2) { grid-area: 1 / 3 / 1 / 4; }
    .jeeHistoGraph .graphs-container.layout-3grid > div:nth-child(3) { grid-area: 2 / 2 / 2 / 3; }

</style>
    <script src="/3rdparty/highstock/modules/timeline.js"></script>
    <script src="/3rdparty/highstock/modules/exporting.js"></script>
    <script src="/3rdparty/highstock/modules/export-data.js"></script>
    <script src="/3rdparty/highstock/modules/accessibility.js"></script>
    <script src="/3rdparty/highstock/highcharts-more.js"></script>
    <script src="/3rdparty/highstock/highcharts-3d.js"></script>
    <div class="graphs-container layout-#graphLayout#" data-layout="#graphLayout#" data-nb-graphs="#nbGraphs#" style="flex: 1; min-height: 0; overflow: hidden; display: grid; gap: 6px; padding: 0;">
        #graph_containers#
    </div>
    <div style="flex: 0 0 auto; text-align: right; font-size: 0.8em; padding: 2px 6px; color: #888;">
        <span>Powered by jeeHistoGraph v#coreVersion# for #version# #message#</span>
    </div>

<script>
        try {
            //Highcharts.setOptions({ time: { useUTC: false } });

            const uid = '#uid#';
            const nbGraphs = parseInt('#nbGraphs#') || 0;
            const now = Date.now();

            window.charts = window.charts || {};
            #chart_scripts#

        } catch(e) { 
            console.error('Erreur Highcharts jeeHistoGraph:', e); 
        }

        var urlParams = new URLSearchParams(window.location.search);
        var pageParam = urlParams.get('p');
        var isDesign = (pageParam === 'plan');  // 'plan' = Design, 'dashboard' = Dashboard

        if (isDesign) {
            // $('.eqLogic[data-eqLogic_uid=#uid#] .graphs-container > div').css('width', '100%').css('height', '100%');
        }

        // Gestion du bouton refresh (inchangé, mais il déclenchera un nouveau render avec détection)
        if ('#refresh_id#' != '') {

            // Log pour debug (visible dans console navigateur)
            console.log('jeeHistoGraph: Mode détecté = ' + (isDesign ? 'Design (plan)' : 'Dashboard'));

            $('.eqLogic[data-eqLogic_uid=#uid#] .refresh').on('click', function () {
                if (!isDesign) {
                    jeedom.cmd.execute({ id: '#refresh_id#' , value: { mode: isDesign ? 'design' : 'dashboard' } });
                } else {
                    jeedom.cmd.execute({ id: '#refresh_id#' , value: { mode: isDesign ? 'design' : 'dashboard' } });
                }
            });
        } else {
            $('.eqLogic[data-eqLogic_uid=#uid#] .refresh').remove();
        }

    </script>
</div>





